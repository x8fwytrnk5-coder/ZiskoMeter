<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TAXAMETER</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
body { font-family:'Montserrat', sans-serif; background:#f0f2f5; margin:0; padding:0; }
.top-bar { display:flex; align-items:center; padding:10px; background: linear-gradient(90deg, #007bff, #00c6ff); color:white; }
.top-bar .logo { height:50px; margin-right:10px; }
main { padding:15px; }
section { background:white; border-radius:12px; padding:15px; margin-bottom:15px; box-shadow:0 3px 8px rgba(0,0,0,0.15); }
input { width:100%; padding:8px; margin:5px 0 10px; border-radius:6px; border:1px solid #ccc; }
.nav-btn { padding:10px 18px; margin:5px 5px 0 0; border:none; border-radius:8px; background:linear-gradient(90deg,#00c6ff,#007bff); color:white; cursor:pointer; font-weight:bold; }
.nav-btn:hover { opacity:0.9; }
#map { border-radius:12px; height:320px; box-shadow:0 2px 6px rgba(0,0,0,0.2); }
.green { color:green; font-weight:bold; }
.red { color:red; font-weight:bold; }
.flex-buttons { display:flex; flex-wrap:wrap; }
.flex-buttons button { flex:1; min-width:100px; }
.suggestions { background:white; border:1px solid #ccc; border-radius:6px; max-height:150px; overflow-y:auto; position:relative; z-index:1000; }
.suggestion-item { padding:5px 10px; cursor:pointer; }
.suggestion-item:hover { background:#007bff; color:white; }
.alert {
  animation: pulse 1.5s infinite;
  border: 2px solid #ff3b3b;
}

@keyframes pulse {
  0%   { box-shadow: 0 0 0 0 rgba(255,59,59,0.6); }
  70%  { box-shadow: 0 0 0 12px rgba(255,59,59,0); }
  100% { box-shadow: 0 0 0 0 rgba(255,59,59,0); }
}
.alert {
  animation: pulse 1.4s infinite;
  border: 2px solid #ff3b3b;
}

@keyframes pulse {
  0% { box-shadow:0 0 0 0 rgba(255,59,59,0.6); }
  70% { box-shadow:0 0 0 14px rgba(255,59,59,0); }
  100% { box-shadow:0 0 0 0 rgba(255,59,59,0); }
}
</style>
</head>

<body>
<header class="top-bar">
<div id="alertBanner" style="
display:none;
background:#ff3b3b;
color:white;
padding:12px;
text-align:center;
font-weight:600;
">
üöñ Vyraz najnesk√¥r o <span id="leaveTime">--:--</span>
</div>
<img src="images/logo.png" alt="PL logo" class="logo">
<h1>TAXAMETER</h1>
</header>

<main>
<section id="vehicle-section">
<h2>Poloha vozidla</h2>
<button id="btnLocate" class="nav-btn">Urƒçi polohu vozidla</button>
<p id="vehicleLocation">Poloha: -</p>
<p id="vehicleAddress">Adresa: -</p>
</section>

<section id="client-section">
<h2>Adresy klienta</h2>
<input type="text" id="pickupAddress" placeholder="Adresa n√°stupu klienta" oninput="suggestAddress(this)">
<div id="pickupSuggestions" class="suggestions"></div>
<input type="text" id="dropoffAddress" placeholder="Adresa cieƒæa klienta" oninput="suggestAddress(this)">
<div id="dropoffSuggestions" class="suggestions"></div>
<input type="number" id="catalogPriceInput" placeholder="Cenn√≠kov√° cena (‚Ç¨)" min="0" step="0.1">
<div class="flex-buttons">
    <button id="btnStart" class="nav-btn">Zaƒça≈• jazdu</button>
    <button id="btnClient" class="nav-btn">Klient</button>
    <button id="btnWait" class="nav-btn">ƒåakanie</button>
    <button id="btnEnd" class="nav-btn">Ukonƒçi≈• jazdu</button>
</div>
</section>

<section id="client-nav-section">
  <h2>Trasa klienta</h2>
  <button id="btnClientNav" class="nav-btn">Zobrazi≈• trasu klienta</button>
</section>

<script>
document.getElementById("btnClientNav").addEventListener("click", async function(){
    const pickup = document.getElementById("pickupAddress").value;
    const dropoff = document.getElementById("dropoffAddress").value;
    const pickupCoords = await geocodeAddress(pickup);
    const dropoffCoords = await geocodeAddress(dropoff);
    if(!pickupCoords || !dropoffCoords){ alert("Skontrolujte adresy klienta"); return; }

    if(routeLayer) map.removeLayer(routeLayer);
    routeLayer=L.polyline([pickupCoords, dropoffCoords], {color:'green'}).addTo(map);
    map.fitBounds(routeLayer.getBounds());
});
</script>

<section id="phone-section">
<h2>Kontakt klienta</h2>
<input type="tel" id="clientPhone" placeholder="Telef√≥nne ƒç√≠slo" pattern="[0-9]{10}">
<button id="btnCall" class="nav-btn">Volaj</button>
<button id="btnSaveClient" class="nav-btn">Ulo≈æi≈• klienta</button>
</section>

<section id="schedule-section">
<h2>Napl√°nova≈• jazdu</h2>
<label>D√°tum a ƒças jazdy:</label>
<input type="datetime-local" id="rideDateTime">
<button id="btnSaveCalendar" class="nav-btn">Ulo≈æi≈• do kalend√°ra</button>
</section>

<section id="countdown-section">
  <h2>Najbli≈æ≈°ia objedn√°vka</h2>
  <p id="countdownText">≈Ωiadna napl√°novan√° jazda</p>
</section>

<section id="countdown-section">
  <h2>ƒåas do jazdy</h2>
  <p id="countdownText">Napl√°novan√° jazda</p>
</section>

<audio id="notifySound">
  <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
</audio>

<section id="map-section">
<h2>Mapa</h2>
<div id="map"></div>
</section>

<section id="poi-section">
<h2>Body na trase (POI)</h2>
<p>Zobrazen√© POI s√∫ filtrovan√© podƒæa lokality klienta. Kliknut√≠m na POI sa prid√° zast√°vka a prepoƒç√≠ta cena.</p>
<ul id="poiList"></ul>
<button id="btnLoadPOI" class="nav-btn">Naƒç√≠ta≈• POI</button>
</section>

<script>
// Funkcia pre naƒç√≠tanie POI podƒæa obce/trasy
async function loadPOI() {
    const pickupAddr = document.getElementById("pickupAddress").value;
    const dropoffAddr = document.getElementById("dropoffAddress").value;
    if (!pickupAddr || !dropoffAddr) { alert("Zadajte adresy klienta"); return; }

    // Z√≠skanie s√∫radn√≠c pickupu a dropoff
    const pickupCoords = await geocodeAddress(pickupAddr);
    const dropoffCoords = await geocodeAddress(dropoffAddr);
    if (!pickupCoords || !dropoffCoords) { alert("Chyba pri geok√≥dovan√≠ adries"); return; }

    // Z√≠skanie obce/n√°zvu mesta z polohy pickupu
    const resp = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pickupCoords[0]}&lon=${pickupCoords[1]}`);
    const data = await resp.json();
    const town = data.address.town || data.address.village || data.address.city || "";

    // Naƒç√≠tanie POI v okol√≠ (OpenStreetMap Overpass API)
    const query = `
        [out:json][timeout:25];
        area["name"="${town}"]->.searchArea;
        (
          node["amenity"="restaurant"](area.searchArea);
          node["amenity"="cafe"](area.searchArea);
          node["tourism"="hotel"](area.searchArea);
        );
        out center 5;
    `;
    try {
        const overpassResp = await fetch("https://overpass-api.de/api/interpreter", {
            method: "POST",
            body: query
        });
        const poiData = await overpassResp.json();
        const poiList = document.getElementById("poiList");
        poiList.innerHTML = "";
        poiData.elements.forEach(poi => {
            const li = document.createElement("li");
            li.textContent = `${poi.tags.name || "Bez n√°zvu"} (${poi.lat.toFixed(5)}, ${poi.lon.toFixed(5)})`;
            li.style.cursor = "pointer";
            li.onclick = async () => {
                // Pridanie zast√°vky na trase
                const stopCoords = [poi.lat, poi.lon];
                if(routeLayer) map.removeLayer(routeLayer);
                routeLayer = L.polyline([vehicleMarker.getLatLng(), stopCoords, dropoffCoords], {color:'blue'}).addTo(map);

                // Prepoƒçet kilometrov a ceny
                const kmToPickup = getDistance(vehicleMarker.getLatLng(), pickupCoords);
                const kmWithStop = getDistance({lat:pickupCoords[0],lng:pickupCoords[1]}, stopCoords);
                const kmToDropoff = getDistance({lat:stopCoords[0], lng:stopCoords[1]}, dropoffCoords);
                const rateToPickup = 0.31, rateWithClient = 0.85;
                const costToPickup = kmToPickup*rateToPickup;
                const costWithClient = (kmWithStop + kmToDropoff)*rateWithClient;
                const totalCost = costToPickup + costWithClient;
                const recommended = totalCost*1.2;

                document.getElementById("costs").textContent = totalCost.toFixed(2)+" ‚Ç¨";
                document.getElementById("recommended").textContent = recommended.toFixed(2)+" ‚Ç¨";
            };
            poiList.appendChild(li);
        });
    } catch(e){ console.error(e); alert("Nepodarilo sa naƒç√≠ta≈• POI"); }
}

document.getElementById("btnLoadPOI").addEventListener("click", loadPOI);
</script>

<script>
document.getElementById("btnLoadPOI").addEventListener("click", async function(){
    const pickup = document.getElementById("pickupAddress").value;
    const dropoff = document.getElementById("dropoffAddress").value;
    if(!pickup || !dropoff){ alert("Zadajte adresy klienta."); return; }

    // Pre geok√≥dovanie adries
    async function geocode(addr){
        const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&countrycodes=sk&q=${encodeURIComponent(addr)}`);
        const data = await resp.json();
        return data.length>0?[parseFloat(data[0].lat),parseFloat(data[0].lon)]:null;
    }

    const start = await geocode(pickup);
    const end = await geocode(dropoff);
    if(!start || !end){ alert("Chyba pri geok√≥dovan√≠ adries."); return; }

    // Tu len simul√°cia POI (v re√°le by sa pou≈æil Overpass API alebo in√Ω zdroj)
    const pois = [
        {name:"Re≈°taur√°cia Alfa", lat:(start[0]+end[0])/2, lon:(start[1]+end[1])/2},
        {name:"Hotel Beta", lat:(start[0]+end[0])/2+0.002, lon:(start[1]+end[1])/2+0.002}
    ];

    const poiDiv = document.getElementById("poiList");
    poiDiv.innerHTML="";
    pois.forEach(p=>{
        const div=document.createElement("div");
        div.textContent=`${p.name} (lat:${p.lat.toFixed(5)}, lon:${p.lon.toFixed(5)})`;
        div.style.cursor="pointer";
        div.onclick=()=>{ 
            if(routeLayer) map.removeLayer(routeLayer); 
            routeLayer=L.polyline([vehicleMarker.getLatLng(), [p.lat,p.lon], end], {color:'blue'}).addTo(map);
            alert(`Trasa aktualizovan√° s bodom: ${p.name}`);
        };
        poiDiv.appendChild(div);
    });
});
</script>

<section id="stops-section">
  <h2>Prida≈• zast√°vky na trase</h2>
  <input type="text" id="stopAddress" placeholder="Zadajte adresu zast√°vky">
  <button id="btnAddStop" class="nav-btn">Prida≈• zast√°vku</button>
  <ul id="stopList"></ul>
</section>

<script>
let stops = []; // pole pre v≈°etky zast√°vky

document.getElementById("btnAddStop").addEventListener("click", async function() {
    const stopAddress = document.getElementById("stopAddress").value.trim();
    if(!stopAddress) { alert("Zadajte adresu zast√°vky"); return; }

    const coords = await geocodeAddress(stopAddress);
    if(!coords) { alert("Zast√°vku sa nepodarilo n√°js≈•"); return; }

    stops.push({ address: stopAddress, coords: coords });

    // Zobrazenie v zozname
    const li = document.createElement("li");
    li.textContent = stopAddress;
    document.getElementById("stopList").appendChild(li);

    // Odstr√°nenie predch√°dzaj√∫cej trasy a markerov (okrem vozidla)
    if(routeLayer) map.removeLayer(routeLayer);

    // Vytvorenie novej trasy: vehicle ‚Üí pickup ‚Üí [stops] ‚Üí dropoff
    const pickupCoords = routeLayer ? routeLayer.getLatLngs()[1] : vehicleMarker.getLatLng();
    const dropoffCoords = routeLayer ? routeLayer.getLatLngs().slice(-1)[0] : pickupCoords;

    const routePoints = [vehicleMarker.getLatLng(), pickupCoords, ...stops.map(s => s.coords), dropoffCoords];
    routeLayer = L.polyline(routePoints, { color: 'blue' }).addTo(map);

    // Pridanie markerov pre nov√© zast√°vky
    stops.forEach(s => {
        L.marker(s.coords).addTo(map).bindPopup("Zast√°vka: " + s.address);
    });

    // Prepoƒçet kilometrov a n√°kladov
    let totalKmWithClient = 0;
    let prev = pickupCoords;
    stops.forEach(s => { totalKmWithClient += getDistance({lat: prev[0], lng: prev[1]}, s.coords); prev = s.coords; });
    totalKmWithClient += getDistance({lat: prev[0], lng: prev[1]}, dropoffCoords);

    const kmToPickup = getDistance(vehicleMarker.getLatLng(), pickupCoords);
    const rateToPickup = 0.31, rateWithClient = 0.85;
    const costToPickup = kmToPickup * rateToPickup;
    const costWithClient = totalKmWithClient * rateWithClient;
    const totalCost = costToPickup + costWithClient;
    const recommended = totalCost * 1.2;

    // Aktualiz√°cia UI
    document.getElementById("costs").textContent = totalCost.toFixed(2) + " ‚Ç¨";
    document.getElementById("recommended").textContent = recommended.toFixed(2) + " ‚Ç¨";
    document.getElementById("stat-km").textContent = "Ubehnut√© km: " + (kmToPickup + totalKmWithClient).toFixed(2);
    document.getElementById("stat-cost").textContent = "Re√°lna hodnota 1km: " + (totalCost / (kmToPickup + totalKmWithClient)).toFixed(2) + " ‚Ç¨";
});
</script>

<script>
document.getElementById("btnAddStop").addEventListener("click", async function(){
    const stopAddr = document.getElementById("extraStop").value;
    if(!stopAddr){ alert("Zadajte adresu zast√°vky."); return; }
    const stopCoords = await geocodeAddress(stopAddr);
    if(!stopCoords){ alert("Chyba pri geok√≥dovan√≠ zast√°vky."); return; }

    const dropoff = document.getElementById("dropoffAddress").value;
    const dropoffCoords = await geocodeAddress(dropoff);
    if(!dropoffCoords){ alert("Chyba pri geok√≥dovan√≠ cieƒæa."); return; }

    if(routeLayer) map.removeLayer(routeLayer);
    routeLayer=L.polyline([vehicleMarker.getLatLng(), stopCoords, dropoffCoords],{color:'blue'}).addTo(map);

    // Prepoƒçet ceny (rovnak√Ω princ√≠p ako calculateRoute)
    const kmToStop = getDistance(vehicleMarker.getLatLng(), stopCoords);
    const kmStopToDrop = getDistance({lat:stopCoords[0],lng:stopCoords[1]}, dropoffCoords);
    const rateToStop=0.31, rateWithClient=0.85;
    const costToStop = kmToStop*rateToStop;
    const costStopToDrop = kmStopToDrop*rateWithClient;
    const totalCost = costToStop + costStopToDrop;
    const recommended = totalCost*1.2;

    document.getElementById("costs").textContent=totalCost.toFixed(2)+" ‚Ç¨";
    document.getElementById("recommended").textContent=recommended.toFixed(2)+" ‚Ç¨";
});
</script>

<section id="traffic-section">
  <h2>Dopravn√© spr√°vy</h2>
  <button id="btnTraffic" class="nav-btn">Naƒç√≠ta≈• dopravn√© spr√°vy</button>
  <div id="trafficList"></div>
</section>

<script>
document.getElementById("btnTraffic").addEventListener("click", async function(){
    const trafficDiv = document.getElementById("trafficList");
    trafficDiv.innerHTML="Naƒç√≠tavam dopravn√© spr√°vy...";
    
    try{
        // Pr√≠klad: R√°dio Express feed
        const resp = await fetch("https://www.radioexpress.sk/rss/doprava"); // len pr√≠klad URL
        const text = await resp.text();
        const parser = new DOMParser();
        const xml = parser.parseFromString(text,"text/xml");
        const items = xml.querySelectorAll("item");
        trafficDiv.innerHTML="";
        items.forEach((item,i)=>{
            if(i>=5) return; // len prv√Ωch 5 spr√°v
            const div = document.createElement("div");
            div.textContent = item.querySelector("title")?.textContent || "Spr√°va";
            trafficDiv.appendChild(div);
        });
    }catch(e){ trafficDiv.innerHTML="Dopravn√© spr√°vy nie s√∫ dostupn√©."; }
});
</script>

<section id="cost-section">
<h2>V√Ωsledky</h2>
<p>Cena z cenn√≠ka: <span id="catalogPrice">0 ‚Ç¨</span></p>
<p>N√°klady: <span id="costs">0 ‚Ç¨</span></p>
<p>Doporuƒçen√° cena: <span id="recommended">0 ‚Ç¨</span></p>
</section>

<section id="statistics">
<h2>≈†tatistiky</h2>
<p id="stat-km">Ubehnut√© km: 0</p>
<p id="stat-time">ƒåas jazdy: 0 min</p>
<p id="stat-cost">Re√°lna hodnota 1km: 0 ‚Ç¨</p>
</section>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
var map = L.map('map').setView([48.146,17.107],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'&copy; OpenStreetMap contributors' }).addTo(map);
var vehicleMarker = L.marker([48.146,17.107]).addTo(map);
var routeLayer = null;
var waitTime = 0;

document.getElementById("btnLocate").addEventListener("click", function(){
    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(async function(pos){
            var lat = pos.coords.latitude, lon = pos.coords.longitude;
            vehicleMarker.setLatLng([lat,lon]); map.setView([lat,lon],14);
            document.getElementById("vehicleLocation").textContent="Poloha vozidla: "+lat.toFixed(5)+", "+lon.toFixed(5);
            try{
                const resp = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                const data = await resp.json();
                document.getElementById("vehicleAddress").textContent = "Adresa: "+(data.display_name||"-");
            }catch(e){document.getElementById("vehicleAddress").textContent="Adresa: -";}
        }, function(err){ alert("Nepodarilo sa z√≠ska≈• polohu: "+err.message); }, {enableHighAccuracy:true});
    } else alert("Geolok√°cia nie je podporovan√°.");
});

async function geocodeAddress(address){
    const url=`https://nominatim.openstreetmap.org/search?format=json&countrycodes=sk&q=${encodeURIComponent(address)}`;
    try{ const resp=await fetch(url); const data=await resp.json(); return data.length>0?[parseFloat(data[0].lat),parseFloat(data[0].lon)]:null;}
    catch(e){ console.error(e); return null;}
}

function getDistance(from,to){ const R=6371; const dLat=(to[0]-from.lat)*Math.PI/180; const dLon=(to[1]-from.lng)*Math.PI/180; const a=Math.sin(dLat/2)**2+Math.cos(from.lat*Math.PI/180)*Math.cos(to[0]*Math.PI/180)*Math.sin(dLon/2)**2; return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); }

async function calculateRoute(){
    const pickup = document.getElementById("pickupAddress").value;
    const dropoff = document.getElementById("dropoffAddress").value;
    let catalogPrice=parseFloat(document.getElementById("catalogPriceInput").value);
    if(isNaN(catalogPrice)||catalogPrice<=0){ alert("Zadajte cenu z cenn√≠ka"); return; }

    const pickupCoords=await geocodeAddress(pickup);
    const dropoffCoords=await geocodeAddress(dropoff);
    if(!pickupCoords||!dropoffCoords){ alert("Skontrolujte adresy"); return; }

    if(routeLayer) map.removeLayer(routeLayer);
    routeLayer=L.polyline([vehicleMarker.getLatLng(),pickupCoords,dropoffCoords],{color:'blue'}).addTo(map);

    const kmToPickup=getDistance(vehicleMarker.getLatLng(),pickupCoords);
    const kmWithClient=getDistance({lat:pickupCoords[0],lng:pickupCoords[1]},dropoffCoords);
    const rateToPickup=0.31, rateWithClient=0.85;
    const costToPickup=kmToPickup*rateToPickup;
    const costWithClient=kmWithClient*rateWithClient;
    const totalCost=costToPickup+costWithClient;
    const recommended=totalCost*1.2;

    document.getElementById("costs").textContent=totalCost.toFixed(2)+" ‚Ç¨";
    document.getElementById("recommended").textContent=recommended.toFixed(2)+" ‚Ç¨";
    document.getElementById("catalogPrice").textContent=catalogPrice.toFixed(2)+" ‚Ç¨";
    document.getElementById("costs").className=catalogPrice>=totalCost?"green":"red";

    document.getElementById("stat-km").textContent="Ubehnut√© km: "+(kmToPickup+kmWithClient).toFixed(2);
    document.getElementById("stat-time").textContent="ƒåas jazdy: "+(kmWithClient*2).toFixed(0)+" min";
    document.getElementById("stat-cost").textContent="Re√°lna hodnota 1km: "+(totalCost/(kmToPickup+kmWithClient)).toFixed(2)+" ‚Ç¨";
}

document.getElementById("btnStart")?.addEventListener("click",calculateRoute);
document.getElementById("btnClient")?.addEventListener("click",calculateRoute);
document.getElementById("btnEnd")?.addEventListener("click",()=>{ alert("Jazda ukonƒçen√°"); waitTime=0; });
document.getElementById("btnWait")?.addEventListener("click",()=>{ waitTime+=1; alert("ƒåakanie: "+waitTime+" min"); });

async function suggestAddress(input){
    const val=input.value;
    const suggestionsDiv=input.id.includes("pickup")?document.getElementById("pickupSuggestions"):document.getElementById("dropoffSuggestions");
    suggestionsDiv.innerHTML="";
    if(val.length<3) return;
    try{
        const resp=await fetch(`https://nominatim.openstreetmap.org/search?format=json&countrycodes=sk&q=${encodeURIComponent(val)}`);
        const data=await resp.json();
        data.slice(0,5).forEach(item=>{
            const div=document.createElement("div");
            div.textContent=item.display_name;
            div.className="suggestion-item";
            div.onclick=()=>{ input.value=item.display_name; suggestionsDiv.innerHTML=""; };
            suggestionsDiv.appendChild(div);
        });
    }catch(e){ console.error(e); }
}

// Funkcia volania klienta (10 ƒç√≠slic)
document.getElementById("btnCall").addEventListener("click", function() {
  const phone = document.getElementById("clientPhone").value.trim();
  const phonePattern = /^09\d{8}$/;
  if(!phonePattern.test(phone)){
    alert("Zadajte platn√© slovensk√© mobiln√© ƒç√≠slo (10 ƒç√≠slic, zaƒç√≠na 09)");
    return;
  }
  window.location.href = "tel:" + phone;
});

// Funkcia ulo≈æenia do kalend√°ra (iCalendar .ics)
document.getElementById("btnSaveCalendar").addEventListener("click", function(){
    const dateInput = document.getElementById("rideDateTime").value;
    const pickup = document.getElementById("pickupAddress").value;
    const dropoff = document.getElementById("dropoffAddress").value;

    if(!dateInput || !pickup || !dropoff){
        alert("Zadajte d√°tum, ƒças a adresy jazdy.");
        return;
    }

    const dt = new Date(dateInput);
    const dtStart = dt.toISOString().replace(/[-:]/g,"").split(".")[0]+"Z";
    const dtEnd = new Date(dt.getTime()+30*60000).toISOString().replace(/[-:]/g,"").split(".")[0]+"Z";

    const title = `Jazda: ${pickup} ‚Üí ${dropoff}`;
    const description = `Objednan√° jazda z ${pickup} do ${dropoff}.`;

    const icsContent = 
`BEGIN:VCALENDAR
VERSION:2.0
BEGIN:VEVENT
DTSTART:${dtStart}
DTEND:${dtEnd}
SUMMARY:${title}
DESCRIPTION:${description}
END:VEVENT
END:VCALENDAR`;

    const blob = new Blob([icsContent], {type:"text/calendar"});
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "Jazda.ics";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
	startCountdown(new Date(dateInput));
});
let countdownTimer = null;
let notified60 = false;
let notified30 = false;
let lastRepeatAlert = null;

function startCountdown(targetDate) {
  if (countdownTimer) clearInterval(countdownTimer);

  notified60 = false;
  notified30 = false;
  lastRepeatAlert = null;

  const countdownSection = document.getElementById("countdown-section");
  const sound = document.getElementById("notifySound");

  countdownTimer = setInterval(() => {
    const now = new Date();
    const diffMs = targetDate - now;

    if (diffMs <= 0) {
      document.getElementById("countdownText").textContent = "üöñ Je ƒças vyrazi≈•!";
      countdownSection.classList.add("alert");

      sound.play();
      if (navigator.vibrate) navigator.vibrate([300, 150, 300]);

      clearInterval(countdownTimer);
      return;
    }

    const minutes = Math.floor(diffMs / 60000);
    const hours = Math.floor(minutes / 60);
    const mins = minutes % 60;

    document.getElementById("countdownText").textContent =
      `‚è≥ Zaƒçiatok jazdy o ${hours} h ${mins} min`;

    // üîî 60 min upozornenie
    if (minutes <= 60 && !notified60) {
      sound.play();
      if (navigator.vibrate) navigator.vibrate(200);
      notified60 = true;
    }

    // üîî 30 min upozornenie + zv√Ωraznenie
    if (minutes <= 30 && !notified30) {
      sound.play();
      if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
      countdownSection.classList.add("alert");
      notified30 = true;
    }

    // üîÅ Opakovan√© upozornenie ka≈æd√Ωch 5 min (posledn√Ωch 30 min)
    if (minutes <= 30) {
      const nowMinutes = now.getMinutes();
      if (lastRepeatAlert !== nowMinutes && nowMinutes % 5 === 0) {
        sound.play();
        if (navigator.vibrate) navigator.vibrate(150);
        lastRepeatAlert = nowMinutes;
      }
    }

  }, 1000);
}
function saveClient() {
  const phone = document.getElementById("clientPhone").value.trim();
  const pickup = document.getElementById("pickupAddress").value;
  const dropoff = document.getElementById("dropoffAddress").value;

  if (!phone || !pickup) {
    alert("Ch√Ωba telef√≥n alebo adresa klienta");
    return;
  }

  let clients = JSON.parse(localStorage.getItem("clients") || "[]");

  clients.push({
    phone,
    pickup,
    dropoff,
    saved: new Date().toISOString()
  });

  localStorage.setItem("clients", JSON.stringify(clients));
  alert("Klient ulo≈æen√Ω");
}

document.getElementById("btnSaveClient")
  .addEventListener("click", saveClient);  

let rides = []; // pole v≈°etk√Ωch jazd

document.getElementById("btnEnd").addEventListener("click", async function(){
    const pickup = document.getElementById("pickupAddress").value;
    const dropoff = document.getElementById("dropoffAddress").value;
    const kmToPickup = parseFloat(document.getElementById("stat-km").dataset.kmToPickup) || 0;
    const kmWithClient = parseFloat(document.getElementById("stat-km").dataset.kmWithClient) || 0;
    const costs = parseFloat(document.getElementById("costs").textContent) || 0;
    const catalogPrice = parseFloat(document.getElementById("catalogPriceInput").value) || 0;
    const recommended = parseFloat(document.getElementById("recommended").textContent) || 0;
    const time = parseFloat(document.getElementById("stat-time").textContent) || 0;

    // ulo≈æi≈• jazdu
    rides.push({kmToPickup, kmWithClient, costs, catalogPrice, recommended, time});

    // aktualizova≈• ≈°tatistiky
    updateStatistics();

    // spusti 15s odpoƒçet pred vymazan√≠m formul√°ra
    let countdown = 15;
    const interval = setInterval(()=>{
        document.getElementById("btnEnd").textContent = `Ukonƒçenie jazdy za ${countdown}s`;
        countdown--;
        if(countdown<0){
            clearInterval(interval);
            document.getElementById("btnEnd").textContent = "Ukonƒçi≈• jazdu";
            // vymaza≈• formul√°r a mapu (marker zost√°va)
            document.getElementById("pickupAddress").value = "";
            document.getElementById("dropoffAddress").value = "";
            document.getElementById("catalogPriceInput").value = "";
            if(routeLayer){ map.removeLayer(routeLayer); routeLayer=null; }
        }
    },1000);
});

function updateStatistics(){
    const totalKm = rides.reduce((sum,r)=>sum+r.kmToPickup+r.kmWithClient,0);
    const totalTime = rides.reduce((sum,r)=>sum+r.time,0);
    const totalCosts = rides.reduce((sum,r)=>sum+r.costs,0);
    const avgKmCost = totalKm? (totalCosts/totalKm) : 0;

    document.getElementById("stat-km").textContent = `Ubehnut√© km: ${totalKm.toFixed(2)}`;
    document.getElementById("stat-time").textContent = `ƒåas jazdy: ${totalTime.toFixed(0)} min`;
    document.getElementById("stat-cost").textContent = `Re√°lna hodnota 1km: ${avgKmCost.toFixed(2)} ‚Ç¨`;
}
</script>
<audio id="alarmSound">
  <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" type="audio/ogg">
</audio>
</body>
</html>
