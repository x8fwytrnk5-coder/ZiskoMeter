<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TAXAMETER</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
body { font-family:'Montserrat', sans-serif; background:#f0f2f5; margin:0; padding:0; }
.top-bar { display:flex; align-items:center; padding:10px; background: linear-gradient(90deg, #007bff, #00c6ff); color:white; }
.top-bar .logo { height:50px; margin-right:10px; }
main { padding:15px; }
section { background:white; border-radius:12px; padding:15px; margin-bottom:15px; box-shadow:0 3px 8px rgba(0,0,0,0.15); }
input { width:100%; padding:8px; margin:5px 0 10px; border-radius:6px; border:1px solid #ccc; }
.nav-btn { padding:10px 18px; margin:5px 5px 0 0; border:none; border-radius:8px; background:linear-gradient(90deg,#00c6ff,#007bff); color:white; cursor:pointer; font-weight:bold; }
.nav-btn:hover { opacity:0.9; }
#map { border-radius:12px; height:320px; box-shadow:0 2px 6px rgba(0,0,0,0.2); }
.green { color:green; font-weight:bold; }
.red { color:red; font-weight:bold; }
.flex-buttons { display:flex; flex-wrap:wrap; }
.flex-buttons button { flex:1; min-width:100px; }
.suggestions { background:white; border:1px solid #ccc; border-radius:6px; max-height:150px; overflow-y:auto; position:relative; z-index:1000; }
.suggestion-item { padding:5px 10px; cursor:pointer; }
.suggestion-item:hover { background:#007bff; color:white; }
.alert { animation: pulse 1.4s infinite; border: 2px solid #ff3b3b; }
@keyframes pulse { 0% { box-shadow:0 0 0 0 rgba(255,59,59,0.6); } 70% { box-shadow:0 0 0 14px rgba(255,59,59,0); } 100% { box-shadow:0 0 0 0 rgba(255,59,59,0); } }
</style>
</head>
<body>
<header class="top-bar">
<img src="logo.png" alt="PL logo" class="logo">
<h1>TAXAMETER</h1>
</header>
<main>
<section id="vehicle-section">
<h2>Poloha vozidla</h2>
<button id="btnLocate" class="nav-btn">Urči polohu vozidla</button>
<p id="vehicleLocation">Poloha: -</p>
<p id="vehicleAddress">Adresa: -</p>
</section>

<section id="client-section">
<h2>Adresy klienta</h2>
<input type="text" id="pickupAddress" placeholder="Adresa nástupu klienta">
<div id="pickupSuggestions" class="suggestions"></div>
<input type="text" id="dropoffAddress" placeholder="Adresa cieľa klienta">
<div id="dropoffSuggestions" class="suggestions"></div>
<input type="number" id="catalogPriceInput" placeholder="Cenníková cena (€)" min="0" step="0.1">
<div class="flex-buttons">
<button id="btnStart" class="nav-btn">Začať jazdu</button>
<button id="btnClient" class="nav-btn">Klient</button>
<button id="btnWait" class="nav-btn">Čakanie</button>
<button id="btnEnd" class="nav-btn">Ukončiť jazdu</button>
</div>
</section>

<section id="map-section">
<h2>Mapa</h2>
<div id="map"></div>
</section>

<section id="statistics">
<h2>Štatistiky</h2>
<p id="stat-km">Ubehnuté km: 0</p>
<p id="stat-time">Čas jazdy: 0 min</p>
<p id="stat-cost">Reálna hodnota 1km: 0 €</p>
<p>Cena z cenníka: <span id="catalogPrice">0 €</span></p>
<p>Náklady: <span id="costs">0 €</span></p>
<p>Doporučená cena: <span id="recommended">0 €</span></p>
<p>Čistý zisk vodiča: <span id="profit">0 €</span></p>
</section>

<audio id="notifySound">
<source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
</audio>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// --- Mapa a vozidlo ---
let map = L.map('map').setView([48.146,17.107],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'&copy; OpenStreetMap contributors' }).addTo(map);
let vehicleMarker = L.marker([48.146,17.107]).addTo(map);
let routeLayer = null;

// --- Poloha vozidla ---
document.getElementById("btnLocate").addEventListener("click", function(){
    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(async function(pos){
            const lat=pos.coords.latitude, lon=pos.coords.longitude;
            vehicleMarker.setLatLng([lat, lon]); map.setView([lat, lon],14);
            document.getElementById("vehicleLocation").textContent=`Poloha vozidla: ${lat.toFixed(5)}, ${lon.toFixed(5)}`;
            try{
                const resp=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                const data=await resp.json();
                document.getElementById("vehicleAddress").textContent="Adresa: "+(data.display_name||"-");
            } catch(e){ document.getElementById("vehicleAddress").textContent="Adresa: -"; }
        }, function(err){ alert("Nepodarilo sa získať polohu: "+err.message); }, {enableHighAccuracy:true});
    } else alert("Geolokácia nie je podporovaná.");
});

// --- Geokódovanie ---
async function geocodeAddress(address){
    try{
        const resp=await fetch(`https://nominatim.openstreetmap.org/search?format=json&countrycodes=sk&q=${encodeURIComponent(address)}`);
        const data=await resp.json();
        return data.length>0 ? [parseFloat(data[0].lat), parseFloat(data[0].lon)] : null;
    } catch(e){ console.error(e); return null; }
}

// --- Našeptávanie adries ---
async function suggestAddress(input){
    const val=input.value;
    const suggestionsDiv = input.id.includes("pickup") ? document.getElementById("pickupSuggestions") : document.getElementById("dropoffSuggestions");
    suggestionsDiv.innerHTML="";
    if(val.length<3) return;
    try{
        const resp=await fetch(`https://nominatim.openstreetmap.org/search?format=json&countrycodes=sk&q=${encodeURIComponent(val)}`);
        const data=await resp.json();
        data.slice(0,5).forEach(item=>{
            const div=document.createElement("div");
            div.textContent=item.display_name;
            div.className="suggestion-item";
            div.onclick=()=>{ input.value=item.display_name; suggestionsDiv.innerHTML=""; };
            suggestionsDiv.appendChild(div);
        });
    } catch(e){ console.error(e); }
}
document.getElementById("pickupAddress").addEventListener("input", (e)=>suggestAddress(e.target));
document.getElementById("dropoffAddress").addEventListener("input", (e)=>suggestAddress(e.target));

// --- Výpočty trasy, ceny a štatistiky ---
let rides = [], stats = { totalKm:0, totalTime:0, totalCost:0 };
function getDistance(from,to){
    const R=6371;
    const dLat=(to[0]-from.lat)*Math.PI/180;
    const dLon=(to[1]-from.lng)*Math.PI/180;
    const a=Math.sin(dLat/2)**2+Math.cos(from.lat*Math.PI/180)*Math.cos(to[0]*Math.PI/180)*Math.sin(dLon/2)**2;
    return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

async function calculateRoute(){
    const pickup=document.getElementById("pickupAddress").value;
    const dropoff=document.getElementById("dropoffAddress").value;
    const catalogPrice=parseFloat(document.getElementById("catalogPriceInput").value)||0;
    if(!pickup||!dropoff){ alert("Zadajte adresy"); return; }

    const pickupCoords=await geocodeAddress(pickup);
    const dropoffCoords=await geocodeAddress(dropoff);
    if(!pickupCoords||!dropoffCoords){ alert("Chyba pri geokódovaní"); return; }

    if(routeLayer) map.removeLayer(routeLayer);
    routeLayer=L.polyline([vehicleMarker.getLatLng(), pickupCoords, dropoffCoords], { color:'blue' }).addTo(map);

    const kmToPickup=getDistance(vehicleMarker.getLatLng(), pickupCoords);
    const kmWithClient=getDistance({lat:pickupCoords[0], lng:pickupCoords[1]}, dropoffCoords);
    const totalCost=kmToPickup*0.31 + kmWithClient*0.85;
    const recommended=totalCost*1.2;
    const provision=catalogPrice*0.2;
    const vat=provision*0.23;
    const profit=catalogPrice - (provision+vat) - totalCost;

    rides.push({kmToPickup, kmWithClient, costs:totalCost, catalogPrice, recommended, time:kmWithClient*2});
    stats.totalKm += kmToPickup+kmWithClient;
    stats.totalTime += kmWithClient*2;
    stats.totalCost += totalCost;

    document.getElementById("costs").textContent=totalCost.toFixed(2)+" €";
    document.getElementById("recommended").textContent=recommended.toFixed(2)+" €";
    document.getElementById("catalogPrice").textContent=catalogPrice.toFixed(2)+" €";
    document.getElementById("profit").textContent=profit.toFixed(2)+" €";
    document.getElementById("stat-km").textContent="Ubehnuté km: "+stats.totalKm.toFixed(2);
    document.getElementById("stat-time").textContent="Čas jazdy: "+Math.round(stats.totalTime)+" min";
    document.getElementById("stat-cost").textContent="Reálna hodnota 1km: "+(stats.totalCost/stats.totalKm).toFixed(2)+" €";

    if(profit<0) alert("⚠️ Upozornenie: jazda je stratová!");
}
document.getElementById("btnStart").addEventListener("click", calculateRoute);
document.getElementById("btnClient").addEventListener("click", calculateRoute);

// --- Čakanie ---
let waitTime=0;
document.getElementById("btnWait").addEventListener("click", ()=>{ waitTime+=1; alert("Čakanie: "+waitTime+" min"); });

// --- Ukončenie jazdy ---
document.getElementById("btnEnd").addEventListener("click", ()=>{
    alert("Jazda ukončená.");
    if(routeLayer){ map.removeLayer(routeLayer); routeLayer=null; }
});
</script>
</body>
</html>
