<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TAXAMETER</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
body { font-family:'Montserrat', sans-serif; background:#f0f2f5; margin:0; padding:0; }
.top-bar { display:flex; align-items:center; padding:10px; background: linear-gradient(90deg, #007bff, #00c6ff); color:white; }
.top-bar .logo { height:50px; margin-right:10px; }
main { padding:15px; }
section { background:white; border-radius:12px; padding:15px; margin-bottom:15px; box-shadow:0 3px 8px rgba(0,0,0,0.15); }
input { width:100%; padding:8px; margin:5px 0 10px; border-radius:6px; border:1px solid #ccc; }
.nav-btn { padding:10px 18px; margin:5px 5px 0 0; border:none; border-radius:8px; background:linear-gradient(90deg,#00c6ff,#007bff); color:white; cursor:pointer; font-weight:bold; }
.nav-btn:hover { opacity:0.9; }
#map { border-radius:12px; height:320px; box-shadow:0 2px 6px rgba(0,0,0,0.2); }
.green { color:green; font-weight:bold; }
.red { color:red; font-weight:bold; }
.flex-buttons { display:flex; flex-wrap:wrap; }
.flex-buttons button { flex:1; min-width:100px; }
.suggestions { background:white; border:1px solid #ccc; border-radius:6px; max-height:150px; overflow-y:auto; position:relative; z-index:1000; }
.suggestion-item { padding:5px 10px; cursor:pointer; }
.suggestion-item:hover { background:#007bff; color:white; }
.alert {
  animation: pulse 1.4s infinite;
  border: 2px solid #ff3b3b;
}
@keyframes pulse {
  0% { box-shadow:0 0 0 0 rgba(255,59,59,0.6); }
  70% { box-shadow:0 0 0 14px rgba(255,59,59,0); }
  100% { box-shadow:0 0 0 0 rgba(255,59,59,0); }
}
</style>
</head>
<body>

<header class="top-bar">
<div id="alertBanner" style="display:none;background:#ff3b3b;color:white;padding:12px;text-align:center;font-weight:600;">
üöñ Vyraz najnesk√¥r o <span id="leaveTime">--:--</span>
</div>
<img src="logo.png" alt="PL logo" class="logo">
<h1>TAXAMETER</h1>
</header>

<main>
<section id="vehicle-section">
<h2>Poloha vozidla</h2>
<button id="btnLocate" class="nav-btn">Urƒçi polohu vozidla</button>
<p id="vehicleLocation">Poloha: -</p>
<p id="vehicleAddress">Adresa: -</p>
</section>

<section id="client-section">
<h2>Adresy klienta</h2>
<input type="text" id="pickupAddress" placeholder="Adresa n√°stupu klienta" oninput="suggestAddress(this)">
<div id="pickupSuggestions" class="suggestions"></div>
<input type="text" id="dropoffAddress" placeholder="Adresa cieƒæa klienta" oninput="suggestAddress(this)">
<div id="dropoffSuggestions" class="suggestions"></div>
<input type="number" id="catalogPriceInput" placeholder="Cenn√≠kov√° cena (‚Ç¨)" min="0" step="0.1">
<div class="flex-buttons">
    <button id="btnStart" class="nav-btn">Zaƒça≈• jazdu</button>
    <button id="btnClient" class="nav-btn">Klient</button>
    <button id="btnWait" class="nav-btn">ƒåakanie</button>
    <button id="btnEnd" class="nav-btn">Ukonƒçi≈• jazdu</button>
</div>
</section>

<section id="client-nav-section">
<h2>Trasa klienta</h2>
<button id="btnClientNav" class="nav-btn">Zobrazi≈• trasu klienta</button>
</section>

<section id="phone-section">
<h2>Kontakt klienta</h2>
<input type="tel" id="clientPhone" placeholder="Telef√≥nne ƒç√≠slo" pattern="[0-9]{10}">
<button id="btnCall" class="nav-btn">Volaj</button>
<button id="btnSaveClient" class="nav-btn">Ulo≈æi≈• klienta</button>
</section>

<section id="schedule-section">
<h2>Napl√°nova≈• jazdu</h2>
<label>D√°tum a ƒças jazdy:</label>
<input type="datetime-local" id="rideDateTime">
<button id="btnSaveCalendar" class="nav-btn">Ulo≈æi≈• do kalend√°ra</button>
</section>

<section id="countdown-section">
<h2>ƒåas do jazdy</h2>
<p id="countdownText">Napl√°novan√° jazda</p>
</section>

<audio id="notifySound">
<source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
</audio>

<section id="map-section">
<h2>Mapa</h2>
<div id="map"></div>
</section>

<section id="poi-section">
<h2>Body na trase (POI)</h2>
<p>Zobrazen√© POI s√∫ filtrovan√© podƒæa lokality klienta. Kliknut√≠m na POI sa prid√° zast√°vka a prepoƒç√≠ta cena.</p>
<ul id="poiList"></ul>
<button id="btnLoadPOI" class="nav-btn">Naƒç√≠ta≈• POI</button>
</section>

<section id="stops-section">
<h2>Prida≈• zast√°vky na trase</h2>
<input type="text" id="stopAddress" placeholder="Zadajte adresu zast√°vky">
<button id="btnAddStop" class="nav-btn">Prida≈• zast√°vku</button>
<ul id="stopList"></ul>
</section>

<section id="traffic-section">
<h2>Dopravn√© spr√°vy</h2>
<button id="btnTraffic" class="nav-btn">Naƒç√≠ta≈• dopravn√© spr√°vy</button>
<div id="trafficList"></div>
</section>

<section id="cost-section">
<h2>V√Ωsledky</h2>
<p>Cena z cenn√≠ka: <span id="catalogPrice">0 ‚Ç¨</span></p>
<p>N√°klady: <span id="costs">0 ‚Ç¨</span></p>
<p>Doporuƒçen√° cena: <span id="recommended">0 ‚Ç¨</span></p>
<p>ƒåist√Ω zisk vodiƒça: <span id="profit">0 ‚Ç¨</span></p>
</section>

<section id="statistics">
<h2>≈†tatistiky</h2>
<p id="stat-km">Ubehnut√© km: 0</p>
<p id="stat-time">ƒåas jazdy: 0 min</p>
<p id="stat-cost">Re√°lna hodnota 1km: 0 ‚Ç¨</p>
</section>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let rides = [];
let stops = [];
var map = L.map('map').setView([48.146,17.107],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'&copy; OpenStreetMap contributors' }).addTo(map);
var vehicleMarker = L.marker([48.146,17.107]).addTo(map);
var routeLayer = null;
let statsTotalKm = 0, statsTotalMinutes = 0, statsTotalCosts = 0;

async function geocodeAddress(address){
    const url=`https://nominatim.openstreetmap.org/search?format=json&countrycodes=sk&q=${encodeURIComponent(address)}`;
    try{ const resp=await fetch(url); const data=await resp.json(); return data.length>0?[parseFloat(data[0].lat),parseFloat(data[0].lon)]:null;}
    catch(e){ console.error(e); return null;}
}

function getDistance(from,to){
    const R=6371;
    const dLat=(to[0]-from.lat)*Math.PI/180;
    const dLon=(to[1]-from.lng)*Math.PI/180;
    const a=Math.sin(dLat/2)**2+Math.cos(from.lat*Math.PI/180)*Math.cos(to[0]*Math.PI/180)*Math.sin(dLon/2)**2;
    return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

document.getElementById("btnLocate").addEventListener("click", function(){
    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(async function(pos){
            var lat = pos.coords.latitude, lon = pos.coords.longitude;
            vehicleMarker.setLatLng([lat,lon]); map.setView([lat,lon],14);
            document.getElementById("vehicleLocation").textContent="Poloha vozidla: "+lat.toFixed(5)+", "+lon.toFixed(5);
            try{
                const resp = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                const data = await resp.json();
                document.getElementById("vehicleAddress").textContent = "Adresa: "+(data.display_name||"-");
            }catch(e){document.getElementById("vehicleAddress").textContent="Adresa: -";}
        }, function(err){ alert("Nepodarilo sa z√≠ska≈• polohu: "+err.message); }, {enableHighAccuracy:true});
    } else alert("Geolok√°cia nie je podporovan√°.");
});

// --- Funkcie pre trasu, klienta, zast√°vky, POI ---
document.getElementById("btnClientNav").addEventListener("click", async function(){
    const pickup = await geocodeAddress(document.getElementById("pickupAddress").value);
    const dropoff = await geocodeAddress(document.getElementById("dropoffAddress").value);
    if(!pickup || !dropoff){ alert("Skontrolujte adresy klienta"); return; }
    if(routeLayer) map.removeLayer(routeLayer);
    routeLayer=L.polyline([pickup,dropoff],{color:'green'}).addTo(map);
    map.fitBounds(routeLayer.getBounds());
});

document.getElementById("btnCall").addEventListener("click", function() {
  const phone = document.getElementById("clientPhone").value.trim();
  const phonePattern = /^09\d{8}$/;
  if(!phonePattern.test(phone)){ alert("Zadajte platn√© ƒç√≠slo (10 ƒç√≠slic, zaƒç√≠na 09)"); return; }
  window.location.href = "tel:" + phone;
});

// --- Funkcie POI, zast√°vky, ≈°tatistiky atƒè ---
function updateStatistics(){
    const totalKm = rides.reduce((sum,r)=>sum+r.kmToPickup+r.kmWithClient,0);
    const totalTime = rides.reduce((sum,r)=>sum+r.time,0);
    const totalCosts = rides.reduce((sum,r)=>sum+r.costs,0);
    const avgKmCost = totalKm? (totalCosts/totalKm) : 0;
    document.getElementById("stat-km").textContent = `Ubehnut√© km: ${totalKm.toFixed(2)}`;
    document.getElementById("stat-time").textContent = `ƒåas jazdy: ${totalTime.toFixed(0)} min`;
    document.getElementById("stat-cost").textContent = `Re√°lna hodnota 1km: ${avgKmCost.toFixed(2)} ‚Ç¨`;
}

// --- Funkcia n√°vrhu adries ---
async function suggestAddress(input){
    const val=input.value;
    const suggestionsDiv=input.id.includes("pickup")?document.getElementById("pickupSuggestions"):document.getElementById("dropoffSuggestions");
    suggestionsDiv.innerHTML="";
    if(val.length<3) return;
    try{
        const resp=await fetch(`https://nominatim.openstreetmap.org/search?format=json&countrycodes=sk&q=${encodeURIComponent(val)}`);
        const data=await resp.json();
        data.slice(0,5).forEach(item=>{
            const div=document.createElement("div");
            div.textContent=item.display_name;
            div.className="suggestion-item";
            div.onclick=()=>{ input.value=item.display_name; suggestionsDiv.innerHTML=""; };
            suggestionsDiv.appendChild(div);
        });
    }catch(e){ console.error(e); }
}

// --- Po zvy≈°ok funkci√≠ typu calculateRoute, addStop, btnEnd atƒè. m√¥≈æe≈° doplni≈• z predch√°dzaj√∫ceho k√≥du ---
// Hlavn√©: mapu a vehicleMarker inicializuj **pred** ich pou≈æit√≠m.
</script>
<audio id="alarmSound">
  <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" type="audio/ogg">
</audio>
</body>
</html>
